/*
 * Corne 36-key OSM keymap
 * hold-tap 完全排除、Callum式 One-Shot ベース
 * Atreus と同じ設計
 */

#include <behaviors.dtsi>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/outputs.h>

#define BASE 0
#define NAV  1
#define SYM  2
#define FUN  3

/ {
    // --- Macros ---
    macros {
        mc_undo: mc_undo {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings = <&kp LG(Z)>;
        };
        mc_cut: mc_cut {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings = <&kp LG(X)>;
        };
        mc_copy: mc_copy {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings = <&kp LG(C)>;
        };
        mc_paste: mc_paste {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings = <&kp LG(V)>;
        };
        mc_redo: mc_redo {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings = <&kp LG(LS(Z))>;
        };
        mc_zmin: mc_zmin {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings = <&kp LG(EQUAL)>;
        };
        mc_zmout: mc_zmout {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings = <&kp LG(MINUS)>;
        };
        // Swapper（Cmd+Tab: キーを離すまでCmdを保持）
        mc_swap: mc_swap {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            wait-ms = <30>;
            tap-ms = <30>;
            bindings = <&macro_press &kp LGUI>, <&macro_tap &kp TAB>, <&macro_pause_for_release>, <&macro_release &kp LGUI>;
        };
        // Tabber（Ctrl+Tab: キーを離すまでCtrlを保持）
        mc_tab: mc_tab {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            wait-ms = <30>;
            tap-ms = <30>;
            bindings = <&macro_press &kp LCTRL>, <&macro_tap &kp TAB>, <&macro_pause_for_release>, <&macro_release &kp LCTRL>;
        };
    };

    // --- Combos ---
    // Corne key positions:
    // Row 0:  0  1  2  3  4  5  |  6  7  8  9 10 11
    // Row 1: 12 13 14 15 16 17  | 18 19 20 21 22 23
    // Row 2: 24 25 26 27 28 29  | 30 31 32 33 34 35
    // Thumb:       36 37 38     |    39 40 41
    //            NAV SPC SYM    | BSPC ENT ---
    combos {
        compatible = "zmk,combos";

        // SPC(37) + BSPC(39) → LNG1 (IME ON)
        combo_lng1 {
            timeout-ms = <50>;
            require-prior-idle-ms = <150>;
            key-positions = <37 39>;
            bindings = <&kp LANGUAGE_1>;
            layers = <BASE>;
        };

        // BSPC(39) + ENT(40) → LNG2 (IME OFF)
        combo_lng2 {
            timeout-ms = <50>;
            require-prior-idle-ms = <150>;
            key-positions = <39 40>;
            bindings = <&kp LANGUAGE_2>;
            layers = <BASE>;
        };
    };

    // --- Conditional Layer (NAV + SYM = FUN) ---
    conditional_layers {
        compatible = "zmk,conditional-layers";
        tri_layer {
            if-layers = <NAV SYM>;
            then-layer = <FUN>;
        };
    };

    // --- Keymap ---
    keymap {
        compatible = "zmk,keymap";

        // Base Layer
        //   Q    W    E    R    T  │  Y    U    I    O    P
        //   A    S    D    F    G  │  H    J    K    L    -
        //   Z    X    C    V    B  │  N    M    ,    .    /
        //             NAV  SPC SYM │  BSPC ENT  ---
        BASE_layer {
            display-name = "Base";
            bindings = <
&none  &kp Q  &kp W  &kp E     &kp R    &kp T        &kp Y     &kp U    &kp I      &kp O    &kp P      &none
&none  &kp A  &kp S  &kp D     &kp F    &kp G        &kp H     &kp J    &kp K      &kp L    &kp MINUS  &none
&none  &kp Z  &kp X  &kp C     &kp V    &kp B        &kp N     &kp M    &kp COMMA  &kp DOT  &kp FSLH   &none
                     &mo NAV   &kp SPC  &mo SYM      &kp BSPC  &kp RET  &none
            >;
        };

        // NAV Layer（左内側親指）
        //   ESC  SWAP STAB CAPS ---  │  HOME PGDN PGUP END  SCRUP
        //   skCTL skSFT skALT skGUI TAB│ LEFT DOWN UP  RGHT SCRDN
        //   UNDO CUT  COPY PST ---  │  REDO --- ZMIN ZMOUT ---
        //             ___  ___  ___ │  ___  ___  ---
        NAV_layer {
            display-name = "Nav";
            bindings = <
&none  &kp ESC      &mc_swap   &mc_tab    &kp CAPS    &none          &kp HOME  &kp PG_DN  &kp PG_UP  &kp END    &kp K_SCROLL_UP    &none
&none  &sk LCTRL    &sk LSHFT  &sk LALT   &sk LGUI    &kp TAB        &kp LEFT  &kp DOWN   &kp UP     &kp RIGHT  &kp K_SCROLL_DOWN  &none
&none  &mc_undo     &mc_cut    &mc_copy   &mc_paste   &none          &mc_redo  &none      &mc_zmin   &mc_zmout  &none              &none
                               &trans     &trans      &trans         &trans    &trans     &none
            >;
        };

        // SYM Layer（左外側親指）
        //   1    2    3    4    5  │  6    7    8    9    0
        //   skCTL skSFT skALT skGUI --- │  =    \    `    ;    '
        //   ---  ---  ---  ---  ---│  [    ]    {    }    |
        //             ___  ___  ___│  ___  ___  ---
        SYM_layer {
            display-name = "Sym";
            bindings = <
&none  &kp N1     &kp N2     &kp N3    &kp N4    &kp N5       &kp N6    &kp N7    &kp N8    &kp N9    &kp N0    &none
&none  &sk LCTRL  &sk LSHFT  &sk LALT  &sk LGUI  &none        &kp EQUAL &kp BSLH  &kp GRAVE &kp SEMI  &kp SQT   &none
&none  &none      &none      &none     &none     &none        &kp LBKT  &kp RBKT  &kp LBRC  &kp RBRC  &kp PIPE  &none
                             &trans    &trans    &trans       &trans    &trans    &none
            >;
        };

        // FUN Layer（NAV + SYM 同時）
        //   F1   F2   F3   F4   F5 │  ---  ---  ---  ---  ---
        //   F6   F7   F8   F9   F10│  MUTE VOLD VOLU ---  ---
        //   F11  F12  ---  ---  ---│  BT0  BT1  BT2  BTCLR OUTTOG
        //             ___  ___  ___│  ___  ___  ---
        FUN_layer {
            display-name = "Fun";
            bindings = <
&none  &kp F1   &kp F2   &kp F3  &kp F4  &kp F5       &none         &none         &none         &none       &none       &none
&none  &kp F6   &kp F7   &kp F8  &kp F9  &kp F10      &kp K_MUTE    &kp K_VOL_DN  &kp K_VOL_UP  &none       &none       &none
&none  &kp F11  &kp F12  &none   &none   &none        &bt BT_SEL 0  &bt BT_SEL 1  &bt BT_SEL 2  &bt BT_CLR  &out OUT_TOG &none
                         &trans  &trans  &trans       &trans        &trans        &none
            >;
        };
    };
};

// --- One-Shot Modifier 設定 ---
&sk {
    release-after-ms = <2000>;
};

// --- Caps Word 設定 ---
// デフォルト設定を使用（カスタマイズなし）
